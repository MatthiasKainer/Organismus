!function(e){const o={};var n;e.LOGLEVEL=void 0,(n=e.LOGLEVEL||(e.LOGLEVEL={}))[n.SILENT=0]="SILENT",n[n.ERROR=1]="ERROR",n[n.INFO=80]="INFO",n[n.DEBUG=90]="DEBUG",n[n.TRACE=100]="TRACE";let r=e.LOGLEVEL.SILENT;let t=[];const s=(o,n,...s)=>{t.forEach((r=>r(e.LOGLEVEL.ERROR,o,n,...s))),r>=e.LOGLEVEL.ERROR&&console.error(n,o,...s)},a=(o,n,...s)=>{if(t.forEach((r=>r(e.LOGLEVEL.INFO,o,n,...s))),r>=e.LOGLEVEL.INFO){(r===e.LOGLEVEL.TRACE?console.trace:console.log)(n,o,...s)}},c=(o,n,...s)=>{if(t.forEach((r=>r(e.LOGLEVEL.DEBUG,o,n,...s))),r>=e.LOGLEVEL.DEBUG){(r===e.LOGLEVEL.TRACE?console.trace:console.log)(n,o,...s)}},i={queue:{},list:{}};function l(e){return e.reduce(((e,o)=>`${e};${o.name};`),"")}const m=new class{constructor(){this.actionDictionary={}}on(e,o){if(Array.isArray(e)){const n=l(e);if(i.list[n])throw s("Hypothalamus.on",new Error("Cannot register the same list of hormones twice"),n),new Error("Cannot register the same list of hormones twice");a("[Hypothalamus.on] Adding new action when all in a list of hormones are released",n,e),i.list[n]={hormones:[...e],callback:o}}else a("Hypothalamus.on","Adding new action when a hormone is released",e.name),this.actionDictionary[e.name]=this.actionDictionary[e.name]||[],this.actionDictionary[e.name].push(o)}drop(e){Array.isArray(e)?(c("Hypothalamus.drop","Dropping a list of hormones",l(e),e),delete i.queue[l(e)],delete i.list[l(e)]):(c("Hypothalamus.drop","Dropping a hormone",e.name),this.actionDictionary[e.name]=[])}dropAll(){c("Hypothalamus.dropAll","Dropping all hormones"),this.actionDictionary={},i.queue={},i.list={}}collect(e,o,n){const r=`collect;;${e.name};${o.name};`;if(i.list[r])throw s("Hypothalamus.collect",new Error("Cannot register the same list of hormones twice"),r),new Error("Cannot register the same list of hormones twice");a("[Hypothalamus.collect] Adding new action when collected hormones are released",r,e,o),i.list[r]={hormones:[o],callback:n}}orchestrate(e,o){this.actionDictionary[e.name]&&this.actionDictionary[e.name].forEach((e=>e(o)));const n=Object.keys(i.queue).filter((o=>o.includes(`;${e.name};`))),r=Object.keys(i.list).filter((o=>o.indexOf(`;${e.name};`)>-1&&n.every((e=>e!==o))));r.forEach((e=>{i.queue[e]={hormones:[...i.list[e].hormones],values:{},callback:i.list[e].callback}}));const t=[...new Set([...n,...r])];for(let n=0;n<t.length;n++){const r=t[n];if(r.startsWith("collect;;")){const[n]=r.replace("collect;;","").split(";");e.name===n?i.queue[r].values[e.name]=[...i.queue[r].values[e.name]||[],o]:(i.queue[r].values[e.name]=o,i.queue[r].callback(i.queue[r].values),delete i.queue[r])}else i.queue[r].hormones=i.queue[r].hormones.filter((o=>o.name!==e.name)),i.queue[r].values[e.name]=o,i.queue[r].hormones.length<1&&(i.queue[r].callback(i.queue[r].values),delete i.queue[r])}}};function d(e,n={}){return u(o)(e,n)}const u=e=>(o,n={})=>{if(e[o]&&!n.loadIfExists)throw s("hormone.defineHormone",new Error("Hormone already created"),o),new Error("Hormone already created");if(e[o]&&n.loadIfExists)return c("hormone.defineHormone","Hormone already created, reusing existing",o),{name:o};const{defaultValue:r,transformation:t,readOnce:a}=n;return e[o]={name:o,value:r,defaultValue:r,transformation:t,receptors:[],readOnce:null!=a&&a},{name:o}};const h=e=>async(o,n)=>{if(!o)throw s("hormone.releaseHormone",new Error("Hormone cannot be undefined")),new Error("Hormone cannot be undefined");const{name:r}=o;if(!e[r])throw s("hormone.releaseHormone",new Error("Hormone does not exist"),r),new Error("Hormone does not exist");var t;t=n,e[r].value=(void 0===t||t instanceof Function)&&n?n(e[r].value):n,a("hormone.releaseHormone","Releasing passed hormone",r,e[r].value);const{receptors:i,transformation:l}=e[r];l&&l(e[r].value);const d=e[r].value;return m.orchestrate({name:r},d),await Promise.all(i.filter((e=>{const o=void 0===e.onlyIf||e.onlyIf(d);return c("hormone.releaseHormone",o?"Keeping receptor because condition matched or no condition":"Filtered receptor from the triggers because condition not matched",e),o})).map((e=>(null==e?void 0:e.onTriggered)?null==e?void 0:e.onTriggered(d):d))),e[r].readOnce&&(c("hormone.releaseHormone","Resetting hormone because it is readOnce",r),e[r].value=e[r].defaultValue),Object.assign({},e[r])};const f=o=>(n,{name:c},i,l)=>{const m=null!=l?l:i,d=l?i:void 0;if(!o[c])throw s("receptor.useReceptor",new Error("Hormone is not defined"),c),new Error(`Hormone "${c}" is not defined`);((e,o,n,r)=>{const t=(null==r?void 0:r.toString())||n;return!e[n].receptors.some((e=>e.parent===o&&e.key===t))})(o,n,c,d)?(a("receptor.useReceptor","Pushing new receptor to hormone",c,{parent:n}),o[c].receptors.push({key:(null==d?void 0:d.toString())||c,parent:n,onlyIf:d,onTriggered:m}),void 0!==o[c].value?m(o[c].value):void 0!==o[c].defaultValue&&m(o[c].defaultValue)):((o,n,...s)=>{t.forEach((r=>r(e.LOGLEVEL.TRACE,o,n,...s))),r===e.LOGLEVEL.TRACE&&console.trace(n,o,...s)})("receptor.useReceptor","Receptor not pushed because already subscribed",c,{parent:n})};e.Organismus=function(){const e={};return{defineHormone:u(e),releaseHormone:h(e),useReceptor:f(e)}},e.defineHormone=d,e.defineSingleHormone=function(e,o={}){return d(e,Object.assign(Object.assign({},o),{readOnce:!0}))},e.getOrDefineHormone=function(e,n={}){return u(o)(e,Object.assign(Object.assign({},n),{loadIfExists:!0}))},e.hypothalamus=m,e.releaseHormone=async function(e,n){return h(o)(e,n)},e.setLoglevel=e=>r=e,e.useReceptor=function(e,{name:n},r,t){return f(o)(e,{name:n},r,t)},Object.defineProperty(e,"o",{value:!0})}({});
